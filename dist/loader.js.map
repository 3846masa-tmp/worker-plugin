{"version":3,"file":"loader.js","sources":["../src/symbol.js","../src/loader.js"],"sourcesContent":["/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nconst WORKER_PLUGIN_SYMBOL = Symbol.for('WORKER_PLUGIN_SYMBOL');\nexport default WORKER_PLUGIN_SYMBOL;\n","/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport loaderUtils from 'loader-utils';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\nimport FetchCompileWasmTemplatePlugin from 'webpack/lib/web/FetchCompileWasmTemplatePlugin';\nimport WORKER_PLUGIN_SYMBOL from './symbol';\n\nconst NAME = 'WorkerPluginLoader';\nlet hasWarned = false;\n\nexport function pitch(request) {\n  this.cacheable(false);\n  const cb = this.async();\n\n  const compilerOptions = this._compiler.options || {};\n  if (!hasWarned && compilerOptions.output && compilerOptions.output.globalObject === 'window') {\n    hasWarned = true;\n    console.warn('Warning (workerize-loader): output.globalObject is set to \"window\". It should be set to \"self\" or \"this\" to support HMR in Workers.');\n  }\n\n  const options = loaderUtils.getOptions(this) || {};\n  const chunkFilename = compilerOptions.output.chunkFilename.replace(/\\.([a-z]+)$/i, '.worker.$1');\n  const workerOptions = {\n    filename: chunkFilename.replace(/\\[(?:chunkhash|contenthash)(:\\d+(?::\\d+)?)?\\]/g, '[hash$1]'),\n    chunkFilename,\n    globalObject: 'self'\n  };\n\n  const pluginOptions = compilerOptions.plugins.find(p => p[WORKER_PLUGIN_SYMBOL]).options;\n  const plugins = (pluginOptions.plugins || []).map(plugin => {\n    if (typeof plugin !== 'string') {\n      return plugin;\n    }\n    const found = compilerOptions.plugins.find(p => p.constructor.name === plugin);\n    if (!found) {\n      console.warn(`Warning (workerize-loader): Plugin \"${plugin}\" is not found.`);\n    }\n    return found;\n  });\n\n  const workerCompiler = this._compilation.createChildCompiler(NAME, workerOptions, plugins);\n  (new WebWorkerTemplatePlugin(workerOptions)).apply(workerCompiler);\n  (new FetchCompileWasmTemplatePlugin({\n    mangleImports: compilerOptions.optimization.mangleWasmImports\n  })).apply(workerCompiler);\n  (new SingleEntryPlugin(this.context, request, options.name)).apply(workerCompiler);\n\n  const subCache = `subcache ${__dirname} ${request}`;\n  workerCompiler.hooks.compilation.tap(NAME, compilation => {\n    if (compilation.cache) {\n      if (!compilation.cache[subCache]) compilation.cache[subCache] = {};\n      compilation.cache = compilation.cache[subCache];\n    }\n  });\n\n  workerCompiler.runAsChild((err, entries, compilation) => {\n    if (!err && compilation.errors && compilation.errors.length) {\n      err = compilation.errors[0];\n    }\n    const entry = entries && entries[0] && entries[0].files[0];\n    if (!err && !entry) err = Error(`WorkerPlugin: no entry for ${request}`);\n    if (err) return cb(err);\n    return cb(null, `module.exports = __webpack_public_path__ + ${JSON.stringify(entry)}`);\n  });\n};\n\nexport default { pitch };\n"],"names":["const","WORKER_PLUGIN_SYMBOL","Symbol","for","NAME","let","hasWarned","pitch","request","cacheable","cb","async","compilerOptions","_compiler","options","output","globalObject","console","warn","loaderUtils","getOptions","chunkFilename","replace","workerOptions","filename","pluginOptions","plugins","find","p","map","plugin","found","constructor","name","workerCompiler","_compilation","createChildCompiler","WebWorkerTemplatePlugin","apply","FetchCompileWasmTemplatePlugin","mangleImports","optimization","mangleWasmImports","SingleEntryPlugin","context","subCache","__dirname","hooks","compilation","tap","cache","runAsChild","err","entries","errors","length","entry","files","Error","JSON","stringify"],"mappings":"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"}